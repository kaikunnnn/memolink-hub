問題点を分析し、修正計画を立てましょう。3つの主な問題があります：aaaaa

Stripeの顧客レコードが重複している問題：

Stripeのダッシュボードで同じメールアドレスの顧客レコードが複数作成されています。
これは、create-checkout-sessionエッジ関数が正しく既存の顧客を検索できていない可能性があります。
サブスクリプション情報がアカウントページに表示されない問題：

Stripeで支払いは成功しているようですが、Supabaseのsubscriptionsテーブルにデータが保存されていません。
これはStripeのWebhookが正しく設定されていないか、処理が完了していない可能性があります。
プランによるコンテンツ制限が機能していない問題：

プレミアムコンテンツにアクセスできないのは、サブスクリプション情報がデータベースに保存されていないためです。
修正計画
1. Webhook設定の確認と修正
Stripeウェブフックの設定を確認し、正しいエンドポイントを指しているか確認します。
stripe-webhookエッジ関数のログを確認し、401エラーの原因を特定します。
ウェブフックのシークレットが正しく設定されているか確認します。
2. データベースにサブスクリプション情報が保存されているか確認
DBログを確認して、サブスクリプションデータがデータベースに書き込まれているか確認します。
Row Level Security(RLS)ポリシーが適切に設定されているか確認します。
Edge Functionが正しく動作し、管理者権限でデータを挿入できているか確認します。
3. Subscriptionsテーブルのポリシー修正
現在のRLSポリシーでは、管理者だけがSubscriptionsテーブルに挿入/更新できるようになっていますが、Webhookからの挿入も許可する必要があります。
エッジ関数がサービスロールキーを使用して書き込んでいるかを確認します。
4. 顧客レコードの重複問題の修正
create-checkout-sessionエッジ関数を修正して、既存の顧客の検索と再利用を適切に行います。
具体的な実装計画
Stripe Webhook設定の修正:

Webhookのエンドポイントを確認し、正しいURLを設定
Webhookのシークレットが環境変数に正しく設定されているか確認
RLSポリシーの修正:

サービスロールを使用してデータ挿入ができるようにポリシーを修正
Edge Function機能テストと修正:

Webhookのログ確認と問題修正
サービスロールキーが正しく使用されているか確認
顧客重複の解決:

既存顧客の検索と再利用ロジックの改善


↓

まず、3つの主な問題があることが分かりました：

Stripeの顧客レコードが重複している
サブスクリプション情報がアカウントページに表示されない
プランによるコンテンツ制限が機能していない
これらの問題は相互に関連しており、根本的な原因は以下の可能性があります：

Webhookの設定問題
RLSポリシーの制限
Edge Functionの実装の問題
まずはWebhookの状況とRLSポリシーを確認しましょう。次に、stripe-webhookエッジ関数を詳しく見てみます。

素晴らしいですね。development-plan.mdを確認しました。計画が明確になっていて、問題点と修正方法が整理されています。この計画に従って進めていきましょう。

まず、3つの主な問題があることが分かりました：

Stripeの顧客レコードが重複している
サブスクリプション情報がアカウントページに表示されない
プランによるコンテンツ制限が機能していない
これらの問題は相互に関連しており、根本的な原因は以下の可能性があります：

Webhookの設定問題
RLSポリシーの制限
Edge Functionの実装の問題
まずはWebhookの状況とRLSポリシーを確認しましょう。次に、stripe-webhookエッジ関数を詳しく見てみます。

Read
supabase/functions/stripe-webhook/index.ts
stripe-webhookエッジ関数のコードを確認しました。コード自体は基本的に良さそうですが、いくつかの点に気づきました：

CORS対応が不足している: リクエストに対するCORSヘッダーが設定されていないため、ブラウザからのリクエストの場合に問題になる可能性があります。

Webhookシークレットの検証: シークレットを使用したイベントの検証は正しく実装されています。しかし、Stripeから実際にWebhookが呼び出されているかどうかを確認するためにはログが必要です。

次に、create-checkout-sessionエッジ関数を見て、顧客の重複問題についても確認しましょう。

stripe-webhookエッジ関数のコードを確認しました。コード自体は基本的に良さそうですが、いくつかの点に気づきました：

CORS対応が不足している: リクエストに対するCORSヘッダーが設定されていないため、ブラウザからのリクエストの場合に問題になる可能性があります。

Webhookシークレットの検証: シークレットを使用したイベントの検証は正しく実装されています。しかし、Stripeから実際にWebhookが呼び出されているかどうかを確認するためにはログが必要です。

次に、create-checkout-sessionエッジ関数を見て、顧客の重複問題についても確認しましょう。

Read
supabase/functions/create-checkout-session/index.ts
create-checkout-sessionエッジ関数も確認しました。こちらは顧客の重複問題の要因が見つかりました。以下の点に注目します：

顧客検索の問題: ユーザーIDを使って顧客情報をデータベースから検索し、既存の顧客があればそのStripe顧客IDを使用する実装になっていますが、.single()を使用しているため、データが見つからない場合にエラーが発生する可能性があります。

認証ロール: このエッジ関数はsupabaseAnonKeyを使用しており、RLSポリシーの制限を受けます。これにより、customer_infoテーブルへの挿入が制限される可能性があります。

次に、RLSポリシーを確認するために、データベースのマイグレーションファイルを見てみましょう。

create-checkout-sessionエッジ関数も確認しました。こちらは顧客の重複問題の要因が見つかりました。以下の点に注目します：

顧客検索の問題: ユーザーIDを使って顧客情報をデータベースから検索し、既存の顧客があればそのStripe顧客IDを使用する実装になっていますが、.single()を使用しているため、データが見つからない場合にエラーが発生する可能性があります。

認証ロール: このエッジ関数はsupabaseAnonKeyを使用しており、RLSポリシーの制限を受けます。これにより、customer_infoテーブルへの挿入が制限される可能性があります。

次に、RLSポリシーを確認するために、データベースのマイグレーションファイルを見てみましょう。

Read
supabase/migrations/20231001000000_subscriptions.sql
RLSポリシーを確認しました。ここで重要な問題点が見つかりました：

サブスクリプションテーブルのポリシー: Only admins can insert subscriptionsとOnly admins can update subscriptionsのポリシーにより、管理者ロールを持つユーザーしかデータを挿入・更新できません。しかし、Stripe Webhookのエッジ関数はStripeからのコールバックとしてサービスロールキーを使用しているため、このポリシーでは制限されてしまいます。

顧客情報テーブルのポリシー: 同様に、Only admins can insert customer infoとOnly admins can update customer infoのポリシーにより、管理者でないユーザーやWebhookからの挿入・更新が制限されます。

create-checkout-sessionの権限問題: このエッジ関数はanonキーを使用しており、RLSポリシーに制限されるため、顧客情報の挿入が正しく行われない可能性があります。

次にサブスクリプション機能に関連するフロントエンドコードも確認しましょう。

RLSポリシーを確認しました。ここで重要な問題点が見つかりました：

サブスクリプションテーブルのポリシー: Only admins can insert subscriptionsとOnly admins can update subscriptionsのポリシーにより、管理者ロールを持つユーザーしかデータを挿入・更新できません。しかし、Stripe Webhookのエッジ関数はStripeからのコールバックとしてサービスロールキーを使用しているため、このポリシーでは制限されてしまいます。

顧客情報テーブルのポリシー: 同様に、Only admins can insert customer infoとOnly admins can update customer infoのポリシーにより、管理者でないユーザーやWebhookからの挿入・更新が制限されます。

create-checkout-sessionの権限問題: このエッジ関数はanonキーを使用しており、RLSポリシーに制限されるため、顧客情報の挿入が正しく行われない可能性があります。

次にサブスクリプション機能に関連するフロントエンドコードも確認しましょう。

Read
src/hooks/useSubscription.tsx
useSubscriptionフックを確認しました。フロントエンドの実装自体は特に問題はなさそうですが、サブスクリプション情報が取得できていない根本的な原因はやはりデータベースにデータが正しく保存されていないことにあります。

最後に、Stripe APIとの連携部分も確認しましょう。

useSubscriptionフックを確認しました。フロントエンドの実装自体は特に問題はなさそうですが、サブスクリプション情報が取得できていない根本的な原因はやはりデータベースにデータが正しく保存されていないことにあります。

最後に、Stripe APIとの連携部分も確認しましょう。

Read
src/utils/stripe.ts
stripe.tsも確認しました。フロントエンドからエッジ関数の呼び出しは正しく実装されています。

これでコードの調査が完了しました。問題点と修正計画をまとめます：

問題点の詳細分析
Stripe顧客レコードの重複問題

create-checkout-sessionエッジ関数が既存顧客の検索に.single()を使用しており、エラー時にも新しい顧客を作成している可能性があります。
customer_infoテーブルに対するRLSポリシーが厳しすぎて、適切な権限で挿入できていない可能性があります。
サブスクリプション情報がデータベースに保存されない問題

stripe-webhookエッジ関数は適切に実装されていますが、Webhookの設定や呼び出しに問題がある可能性があります。
subscriptionsテーブルのRLSポリシーが厳しすぎて、Webhookからのデータ挿入が制限されている可能性があります。
プランによるコンテンツ制限が機能しない問題

これは上記2つの問題の結果です。データベースに正しくサブスクリプション情報が保存されていないため、アクセス制御が機能していません。
修正計画$$
RLSポリシーの修正

subscriptionsテーブルとcustomer_infoテーブルのRLSポリシーを変更し、サービスロールキーを使用したエッジ関数からの挿入と更新を許可します。
具体的には「サービスロールを使用したすべてのオペレーションを許可」するポリシーを追加します。
Webhookの設定確認と修正

Stripeダッシュボードでのウェブフック設定が正しいURLを指しているか確認
ウェブフックのシークレットが環境変数に正しく設定されているか確認
stripe-webhookエッジ関数にCORSヘッダーを追加
ウェブフックのログを確認して正しく呼び出されているか検証
create-checkout-sessionエッジ関数の修正

顧客検索の際に.single()の代わりに.maybeSingle()を使用して、データが見つからない場合でもエラーとならないようにします。
エッジ関数がサービスロールキーを使用するように修正し、RLSの制限を回避します。
詳細なログの追加

デバッグを容易にするために、各エッジ関数に詳細なログを追加します。
これらの修正を実施することで、サブスクリプションシステムが正しく機能するようになり、3つの問題すべてが解決されると期待できます。

実装計画をさらに詳細に示しますと：

具体的な実装計画
RLSポリシーの修正

新しいRLSポリシーをSQLで追加し、サービスロールからの操作を許可
create-checkout-session関数の修正

既存顧客検索のロジックを改善し、サービスロールキーを使用するように変更
stripe-webhook関数の修正

CORSヘッダーを追加し、詳細なログを実装
Stripe Webhookの設定確認

Stripeダッシュボードで正しい設定を確認