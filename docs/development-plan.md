問題点を分析し、修正計画を立てましょう。3つの主な問題があります：

Stripeの顧客レコードが重複している問題：

Stripeのダッシュボードで同じメールアドレスの顧客レコードが複数作成されています。
これは、create-checkout-sessionエッジ関数が正しく既存の顧客を検索できていない可能性があります。
サブスクリプション情報がアカウントページに表示されない問題：

Stripeで支払いは成功しているようですが、Supabaseのsubscriptionsテーブルにデータが保存されていません。
これはStripeのWebhookが正しく設定されていないか、処理が完了していない可能性があります。
プランによるコンテンツ制限が機能していない問題：

プレミアムコンテンツにアクセスできないのは、サブスクリプション情報がデータベースに保存されていないためです。
修正計画
1. Webhook設定の確認と修正
Stripeウェブフックの設定を確認し、正しいエンドポイントを指しているか確認します。
stripe-webhookエッジ関数のログを確認し、401エラーの原因を特定します。
ウェブフックのシークレットが正しく設定されているか確認します。
2. データベースにサブスクリプション情報が保存されているか確認
DBログを確認して、サブスクリプションデータがデータベースに書き込まれているか確認します。
Row Level Security(RLS)ポリシーが適切に設定されているか確認します。
Edge Functionが正しく動作し、管理者権限でデータを挿入できているか確認します。
3. Subscriptionsテーブルのポリシー修正
現在のRLSポリシーでは、管理者だけがSubscriptionsテーブルに挿入/更新できるようになっていますが、Webhookからの挿入も許可する必要があります。
エッジ関数がサービスロールキーを使用して書き込んでいるかを確認します。
4. 顧客レコードの重複問題の修正
create-checkout-sessionエッジ関数を修正して、既存の顧客の検索と再利用を適切に行います。
具体的な実装計画
Stripe Webhook設定の修正:

Webhookのエンドポイントを確認し、正しいURLを設定
Webhookのシークレットが環境変数に正しく設定されているか確認
RLSポリシーの修正:

サービスロールを使用してデータ挿入ができるようにポリシーを修正
Edge Function機能テストと修正:

Webhookのログ確認と問題修正
サービスロールキーが正しく使用されているか確認
顧客重複の解決:

既存顧客の検索と再利用ロジックの改善